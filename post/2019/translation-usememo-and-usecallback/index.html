<!DOCTYPE html>
<html lang="zh" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>【译】什么时候使用 useMemo 和 useCallback - 键落云起</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="君临" />
  <meta name="description" content=" 原文：When to useMemo and useCallback
 性能优化总是会有成本，但并不总是带来好处。我们来谈谈 useMemo 和 useCallback 的成本和收益。
" />

  <meta name="keywords" content="Hugo, theme, jane, 博客" />






<meta name="generator" content="Hugo 0.57.2" />


<link rel="canonical" href="https://jancat.github.io/post/2019/translation-usememo-and-usecallback/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="【译】什么时候使用 useMemo 和 useCallback" />
<meta property="og:description" content="
原文：When to useMemo and useCallback


性能优化总是会有成本，但并不总是带来好处。我们来谈谈 useMemo 和 useCallback 的成本和收益。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jancat.github.io/post/2019/translation-usememo-and-usecallback/" />
<meta property="article:published_time" content="2019-08-19T21:18:32+08:00" />
<meta property="article:modified_time" content="2019-08-19T21:24:00+08:00" />
<meta itemprop="name" content="【译】什么时候使用 useMemo 和 useCallback">
<meta itemprop="description" content="
原文：When to useMemo and useCallback


性能优化总是会有成本，但并不总是带来好处。我们来谈谈 useMemo 和 useCallback 的成本和收益。">


<meta itemprop="datePublished" content="2019-08-19T21:18:32&#43;08:00" />
<meta itemprop="dateModified" content="2019-08-19T21:24:00&#43;08:00" />
<meta itemprop="wordCount" content="3830">



<meta itemprop="keywords" content="React,useMemo,useCallback," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="【译】什么时候使用 useMemo 和 useCallback"/>
<meta name="twitter:description" content="
原文：When to useMemo and useCallback


性能优化总是会有成本，但并不总是带来好处。我们来谈谈 useMemo 和 useCallback 的成本和收益。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138698332-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">键落云起</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/about/">关于</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      键落云起
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/about/">关于</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">【译】什么时候使用 useMemo 和 useCallback</h1>
      
      <div class="post-meta">
        <time datetime="2019-08-19" class="post-time">
          2019-08-19
        </time>
        <div class="post-category">
            <a href="https://jancat.github.io/categories/%E8%AF%91%E6%96%87/"> 译文 </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#为什么-usecallback-更糟糕">为什么 useCallback 更糟糕？！</a></li>
<li><a href="#usememo-虽然不同-但却是相似的">useMemo 虽然不同，但却是相似的？</a></li>
<li><a href="#重点是什么">重点是什么？</a></li>
<li><a href="#所以我应该什么时候使用-usememo-和-usecallback">所以我应该什么时候使用 useMemo 和 useCallback？</a></li>
<li><a href="#引用相等">引用相等</a>
<ul>
<li><a href="#依赖列表">依赖列表</a></li>
<li><a href="#react-memo">React.memo</a></li>
</ul></li>
<li><a href="#昂贵的计算">昂贵的计算</a></li>
<li><a href="#总结">总结</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <blockquote>
<p>原文：<a href="https://kentcdodds.com/blog/usememo-and-usecallback">When to useMemo and useCallback</a></p>
</blockquote>

<p>性能优化总是会有成本，但并不总是带来好处。我们来谈谈 <code>useMemo</code> 和 <code>useCallback</code> 的成本和收益。</p>

<p>这里是一个糖果提售货机：</p>

<p><img src="https://lg-gxg3fdgs-1254198195.cos.ap-shanghai.myqcloud.com/blog/20190730212055.png" alt="" /></p>

<p>（原文中可点击交互，点击 &ldquo;grab&rdquo; 按钮后“提取”对应的糖果，对应项会从页面删除；全部提取完后会出现 &ldquo;refill&rdquo; 按钮，点击重置所有糖果）</p>

<p>以下是它的实现方式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kd">function</span> <span class="nx">CandyDispenser</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">initialCandies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snickers&#39;</span><span class="p">,</span> <span class="s1">&#39;skittles&#39;</span><span class="p">,</span> <span class="s1">&#39;twix&#39;</span><span class="p">,</span> <span class="s1">&#39;milky way&#39;</span><span class="p">]</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">candies</span><span class="p">,</span> <span class="nx">setCandies</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="nx">initialCandies</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">dispense</span> <span class="o">=</span> <span class="nx">candy</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">setCandies</span><span class="p">(</span><span class="nx">allCandies</span> <span class="p">=&gt;</span> <span class="nx">allCandies</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span> <span class="p">=&gt;</span> <span class="nx">c</span> <span class="o">!==</span> <span class="nx">candy</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="nx">Candy</span> <span class="nx">Dispenser</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">Available</span> <span class="nx">Candy</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="nx">candies</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setCandies</span><span class="p">(</span><span class="nx">initialCandies</span><span class="p">)}&gt;</span><span class="nx">refill</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">)</span> <span class="o">:</span> <span class="p">(</span>
          <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
            <span class="p">{</span><span class="nx">candies</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">candy</span> <span class="p">=&gt;</span> <span class="p">(</span>
              <span class="p">&lt;</span><span class="nt">li</span> <span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">candy</span><span class="p">}&gt;</span>
                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">dispense</span><span class="p">(</span><span class="nx">candy</span><span class="p">)}&gt;</span><span class="nx">grab</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span> <span class="p">{</span><span class="nx">candy</span><span class="p">}</span>
              <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">))}</span>
          <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="p">)}</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>现在我想问你一个问题，我希望你在继续之前好好想想。我要做一个改变，我想让你告诉我哪一个会有更好的性能特征。</p>

<p>我唯一要改变的是在 <code>React.useCallback</code> 里包裹 <code>dispense</code> 函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kr">const</span> <span class="nx">dispense</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useCallback</span><span class="p">(</span><span class="nx">candy</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">setCandies</span><span class="p">(</span><span class="nx">allCandies</span> <span class="p">=&gt;</span> <span class="nx">allCandies</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span> <span class="p">=&gt;</span> <span class="nx">c</span> <span class="o">!==</span> <span class="nx">candy</span><span class="p">))</span>
<span class="p">},</span> <span class="p">[])</span></code></pre></td></tr></table>
</div>
</div>
<p>这是<strong>原来</strong>的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kr">const</span> <span class="nx">dispense</span> <span class="o">=</span> <span class="nx">candy</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">setCandies</span><span class="p">(</span><span class="nx">allCandies</span> <span class="p">=&gt;</span> <span class="nx">allCandies</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span> <span class="p">=&gt;</span> <span class="nx">c</span> <span class="o">!==</span> <span class="nx">candy</span><span class="p">))</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>所以我的问题是，在这个特定的例子中，哪一个对性能更好？原来的还是 <code>useCallback</code>？</p>

<p>如果你选择的是 <code>useCallback</code>，再好好思考下。</p>

<p>正确答案是：使用原来的代码性能会更好😉</p>

<h2 id="为什么-usecallback-更糟糕">为什么 useCallback 更糟糕？！</h2>

<p>我们听到很多你应该使用 <code>React.useCallback</code> 来提高性能，并且“内联函数可能会对性能造成问题”，那么不使用<code>callCallback</code> 是如何变得更好的？</p>

<p>从我们的具体例子中退后一步，甚至从React那里考虑一下：<strong>执行的每行代码都有成本</strong>。让我稍微重构一下 <code>useCallback</code> 的例子来更清楚地说明事情（没有实际的改变，只是移动下代码）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kr">const</span> <span class="nx">dispense</span> <span class="o">=</span> <span class="nx">candy</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">setCandies</span><span class="p">(</span><span class="nx">allCandies</span> <span class="p">=&gt;</span> <span class="nx">allCandies</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span> <span class="p">=&gt;</span> <span class="nx">c</span> <span class="o">!==</span> <span class="nx">candy</span><span class="p">))</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">dispenseCallback</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useCallback</span><span class="p">(</span><span class="nx">dispense</span><span class="p">,</span> <span class="p">[])</span></code></pre></td></tr></table>
</div>
</div>
<p>这是原来的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kr">const</span> <span class="nx">dispense</span> <span class="o">=</span> <span class="nx">candy</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">setCandies</span><span class="p">(</span><span class="nx">allCandies</span> <span class="p">=&gt;</span> <span class="nx">allCandies</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span> <span class="p">=&gt;</span> <span class="nx">c</span> <span class="o">!==</span> <span class="nx">candy</span><span class="p">))</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>注意到了吗？让我们看一下 diff：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">const dispense = candy =&gt; {
    setCandies(allCandies =&gt; allCandies.filter(c =&gt; c !== candy))
  }
<span class="gi">+ const dispenseCallback = React.useCallback(dispense, [])
</span></code></pre></td></tr></table>
</div>
</div>
<p>是的，除了<code>useCallback</code>版本做了更多的工作之外，它们完全相同。 我们不仅需要定义函数，还要定义一个数组（<code>[]</code>）并调用 <code>React.useCallback</code>，它本身会设置属性和运行逻辑表达式等。</p>

<p>因此，在这两种情况下，JavaScript 必须在每次渲染中为函数定义分配内存，并且根据 <code>useCallback</code> 的实现方式，你可能会获得更多的函数定义内存分配（实际情况并非如此，但重点还在这里）。这就是我试图通过我的 Twitter 民意调查得到的：</p>

<p><img src="https://lg-gxg3fdgs-1254198195.cos.ap-shanghai.myqcloud.com/blog/20190730215347.png" alt="" /></p>

<p>我还想提一下，在组件的第二次渲染中，原来的 <code>dispense</code> 函数被垃圾收集（释放内存空间），然后创建一个新的 <code>dispense</code> 函数。 但是使用 <code>useCallback</code> 时，原来的 <code>dispense</code> 函数不会被垃圾收集，并且会创建一个新的 <code>dispense</code> 函数，所以从内存的角度来看，这会变得更糟。</p>

<p>作为一个相关的说明，如果你有其它依赖，那么React很可能会挂起对前面函数的引用，因为 <strong>memoization</strong> 通常意味着我们保留旧值的副本，以便在我们获得与先前给出的相同依赖的情况下返回。 特别聪明的你会注意到，这意味着React还必须挂在对这个等式检查依赖项的引用上（由于闭包，这种情况可能会偶然发生，但无论如何它都值得一提）。</p>

<h2 id="usememo-虽然不同-但却是相似的">useMemo 虽然不同，但却是相似的？</h2>

<p><code>useMemo</code> 类似于 <code>useCallback</code>，除了它允许你将 <strong>memoization</strong> 应用于任何值类型（不仅仅是函数）。 它通过接受一个返回值的函数来实现这一点，然后<strong>只在</strong>需要检索值时调用该函数（通常这只有在每次渲染中依赖项数组中的元素发生变化时才会发生一次）。</p>

<p>所以，如果我不想在每次渲染时初始化那个 <code>initialCandies</code> 数组，我可以做这个改变：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff"><span class="gd">- const initialCandies = [&#39;snickers&#39;, &#39;skittles&#39;, &#39;twix&#39;, &#39;milky way&#39;]
</span><span class="gd"></span><span class="gi">+ const initialCandies = React.useMemo(
</span><span class="gi">+  () =&gt; [&#39;snickers&#39;, &#39;skittles&#39;, &#39;twix&#39;, &#39;milky way&#39;],
</span><span class="gi">+  [],
</span><span class="gi">+ )
</span></code></pre></td></tr></table>
</div>
</div>
<p>我可以避免那个问题，但是节省的成本是如此之小，以至于换来使代码更加复杂的成本是不值得的。实际上，这里使用<code>useMemo</code> 也可能会更糟，因为我们再次进行了函数调用，并且代码会执行属性赋值等。</p>

<p>在这个特定的场景中，更好的方法是进行这个更改：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff"><span class="gi">+ const initialCandies = [&#39;snickers&#39;, &#39;skittles&#39;, &#39;twix&#39;, &#39;milky way&#39;]
</span><span class="gi"></span>  function CandyDispenser() {
<span class="gd">-   const initialCandies = [&#39;snickers&#39;, &#39;skittles&#39;, &#39;twix&#39;, &#39;milky way&#39;]
</span><span class="gd"></span>    const [candies, setCandies] = React.useState(initialCandies)
</code></pre></td></tr></table>
</div>
</div>
<p>但有时你没有那么奢侈，因为这个值要么来源于 <code>props</code> 或者函数体内初始化的其它变量。</p>

<p>关键是这两种方式无关紧要，优化这些代码的好处是如此微不足道，以至于你可以更好地花时间来改善产品质量。</p>

<h2 id="重点是什么">重点是什么？</h2>

<p>重点是：</p>

<p><strong>性能优化不是免费的。 它们总是带来成本，但这并不总是带来好处来抵消成本。</strong></p>

<p>因此，负责任地进行优化。</p>

<h2 id="所以我应该什么时候使用-usememo-和-usecallback">所以我应该什么时候使用 useMemo 和 useCallback？</h2>

<p>这两个 hooks 内置于 React 都有特别的原因：</p>

<ol>
<li>引用相等</li>
<li>昂贵的计算</li>
</ol>

<h2 id="引用相等">引用相等</h2>

<p>如果你是 JavaScript 或者编程新手，你很快就会明白为什么会这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kc">true</span> <span class="o">===</span> <span class="kc">true</span> <span class="c1">// true
</span><span class="c1"></span><span class="kc">false</span> <span class="o">===</span> <span class="kc">false</span> <span class="c1">// true
</span><span class="c1"></span><span class="mi">1</span> <span class="o">===</span> <span class="mi">1</span> <span class="c1">// true
</span><span class="c1"></span><span class="s1">&#39;a&#39;</span> <span class="o">===</span> <span class="s1">&#39;a&#39;</span> <span class="c1">// true
</span><span class="c1"></span>
<span class="p">{}</span> <span class="o">===</span> <span class="p">{}</span> <span class="c1">// false
</span><span class="c1"></span><span class="p">[]</span> <span class="o">===</span> <span class="p">[]</span> <span class="c1">// false
</span><span class="c1"></span><span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{}</span> <span class="o">===</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{}</span> <span class="c1">// false
</span><span class="c1"></span>
<span class="k">const</span> <span class="nx">z</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">z</span> <span class="o">===</span> <span class="nx">z</span> <span class="c1">// true
</span><span class="c1"></span>
<span class="c1">// NOTE: React actually uses Object.is, but it&#39;s very similar to ===
</span></code></pre></td></tr></table>
</div>
</div>
<p>我不打算深入研究这个问题，但是当你在React函数组件中定义一个对象时，它跟上次定义的相同对象，引用是不一样的（即使它具有所有相同值和相同属性），这足以说明这个问题。</p>

<p>在React中，有两种情况下引用相等很重要，让我们一个个地来看。</p>

<h3 id="依赖列表">依赖列表</h3>

<p>让我们来回顾一个例子。</p>

<blockquote>
<p>警告，你将看到一些人为故意设计的代码。请不要吹毛求疵，只关注概念，谢谢。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kd">function</span> <span class="nx">Foo</span><span class="p">({</span><span class="nx">bar</span><span class="p">,</span> <span class="nx">baz</span><span class="p">})</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span><span class="nx">bar</span><span class="p">,</span> <span class="nx">baz</span><span class="p">}</span>
  <span class="nx">React</span><span class="p">.</span><span class="nx">useEffect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">buzz</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
  <span class="p">},</span> <span class="p">[</span><span class="nx">options</span><span class="p">])</span> <span class="c1">// we want this to re-run if bar or baz change
</span><span class="c1"></span>  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">foobar</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">Blub</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">Foo</span> <span class="na">bar</span><span class="o">=</span><span class="s">&#34;bar value&#34;</span> <span class="na">baz</span><span class="o">=</span><span class="p">{</span><span class="mi">3</span><span class="p">}</span> <span class="p">/&gt;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里有问题的原因是因为 <code>useEffect</code> 将对每次渲染中对 <code>options</code> 进行引用相等性检查，并且由于JavaScript的工作方式，每次渲染 <code>options</code> 都是新的，所以当React测试 <code>options</code> 是否在渲染之间发生变化时，它将始终计算为 <code>true</code>，意味着每次渲染后都会调用 <code>useEffect</code> 回调，而不是仅在 <code>bar</code> 和 <code>baz</code> 更改时调用。</p>

<p>我们可以做两件事来解决这个问题：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="c1">// option 1
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">Foo</span><span class="p">({</span><span class="nx">bar</span><span class="p">,</span> <span class="nx">baz</span><span class="p">})</span> <span class="p">{</span>
  <span class="nx">React</span><span class="p">.</span><span class="nx">useEffect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span><span class="nx">bar</span><span class="p">,</span> <span class="nx">baz</span><span class="p">}</span>
    <span class="nx">buzz</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
  <span class="p">},</span> <span class="p">[</span><span class="nx">bar</span><span class="p">,</span> <span class="nx">baz</span><span class="p">])</span> <span class="c1">// we want this to re-run if bar or baz change
</span><span class="c1"></span>  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">foobar</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这是个不错的选择，如果这是真的，我就会这么做。</p>

<p>但是有一种情况下：如果 <code>bar</code> 或者 <code>baz</code> 是（非原始值）对象、数组、函数等，这不是一个实际的解决方案：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kd">function</span> <span class="nx">Blub</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">bar</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{}</span>
  <span class="kr">const</span> <span class="nx">baz</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">Foo</span> <span class="na">bar</span><span class="o">=</span><span class="p">{</span><span class="nx">bar</span><span class="p">}</span> <span class="na">baz</span><span class="o">=</span><span class="p">{</span><span class="nx">baz</span><span class="p">}</span> <span class="p">/&gt;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这正是 <code>useCallback</code> 和 <code>useMemo</code> 存在的原因。你可以这样解决这个问题（现在都放一起了）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kd">function</span> <span class="nx">Foo</span><span class="p">({</span><span class="nx">bar</span><span class="p">,</span> <span class="nx">baz</span><span class="p">})</span> <span class="p">{</span>
  <span class="nx">React</span><span class="p">.</span><span class="nx">useEffect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span><span class="nx">bar</span><span class="p">,</span> <span class="nx">baz</span><span class="p">}</span>
    <span class="nx">buzz</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
  <span class="p">},</span> <span class="p">[</span><span class="nx">bar</span><span class="p">,</span> <span class="nx">baz</span><span class="p">])</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">foobar</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">Blub</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">bar</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useCallback</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{},</span> <span class="p">[])</span>
  <span class="kr">const</span> <span class="nx">baz</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useMemo</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[])</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">Foo</span> <span class="na">bar</span><span class="o">=</span><span class="p">{</span><span class="nx">bar</span><span class="p">}</span> <span class="na">baz</span><span class="o">=</span><span class="p">{</span><span class="nx">baz</span><span class="p">}</span> <span class="p">/&gt;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>请注意，同样的事情也适用于传递给 <code>useEffect</code>, <code>useLayoutEffect</code><em>,</em> <code>useCallback</code>, 和  <code>useMemo</code> 的依赖项数组。</p>
</blockquote>

<h3 id="react-memo">React.memo</h3>

<blockquote>
<p>警告，你将看到一些人为故意设计的代码。请不要吹毛求疵，只关注概念，谢谢。</p>
</blockquote>

<p>看看这个：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kd">function</span> <span class="nx">CountButton</span><span class="p">({</span><span class="nx">onClick</span><span class="p">,</span> <span class="nx">count</span><span class="p">})</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">onClick</span><span class="p">}&gt;{</span><span class="nx">count</span><span class="p">}&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">DualCounter</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">count1</span><span class="p">,</span> <span class="nx">setCount1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">increment1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">setCount1</span><span class="p">(</span><span class="nx">c</span> <span class="p">=&gt;</span> <span class="nx">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

  <span class="kr">const</span> <span class="p">[</span><span class="nx">count2</span><span class="p">,</span> <span class="nx">setCount2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">increment2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">setCount2</span><span class="p">(</span><span class="nx">c</span> <span class="p">=&gt;</span> <span class="nx">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;&gt;</span>
      <span class="p">&lt;</span><span class="nt">CountButton</span> <span class="na">count</span><span class="o">=</span><span class="p">{</span><span class="nx">count1</span><span class="p">}</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">increment1</span><span class="p">}</span> <span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nt">CountButton</span> <span class="na">count</span><span class="o">=</span><span class="p">{</span><span class="nx">count2</span><span class="p">}</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">increment2</span><span class="p">}</span> <span class="p">/&gt;</span>
    <span class="o">&lt;</span><span class="err">/&gt;</span>
  <span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>每次单击其中任何一个按钮时，<code>DualCounter</code> 的状态都会发生变化，因此会重新渲染，然后重新渲染两个<code>CountButton</code>。 但是，实际上只需要重新渲染被点击的那个按钮吧？因此，如果你点击第一个按钮，则第二个也会重新渲染，但没有任何变化，我们称之为“不必要的重新渲染”。</p>

<p><strong>大多数时候，你不需要考虑去优化不必要的重新渲染</strong>。React是非常快的，我能想到你可以利用时间去做很多事情，比起做这些类似的优化要好得多。事实上，我展示给你看的代码很少有优化的需求，以至于我在 PayPal 工作的3年里从未需要这样做，甚至在我使用 React 更长的时间里。</p>

<p>然而，有些情况下渲染可能会花费大量时间（比如重交互的图表、动画等）。多亏 React 的实用性，有一个逃生舱（escape hatch）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kr">const</span> <span class="nx">CountButton</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">memo</span><span class="p">(</span><span class="kd">function</span> <span class="nx">CountButton</span><span class="p">({</span><span class="nx">onClick</span><span class="p">,</span> <span class="nx">count</span><span class="p">})</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">onClick</span><span class="p">}&gt;{</span><span class="nx">count</span><span class="p">}&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<p>现在 React 只会当 <code>props</code> 改变时会重新渲染 <code>CountButton</code>！  但我们还没有完成，还记得引用相等吗？在 <code>DualCounter</code> 组件中，我们组件函数里定义了 <code>increment1</code> 和 <code>increment2</code> 函数，这意味着每次 <code>DualCounter</code> 重新渲染，那些函数会新创建，因此 React 无论如何会重新渲染两个 <code>CountButton</code>。</p>

<p>所以这是 <code>useCallback</code> 和 <code>useMemo</code> 能派上用场的另外一个场景：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kr">const</span> <span class="nx">CountButton</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">memo</span><span class="p">(</span><span class="kd">function</span> <span class="nx">CountButton</span><span class="p">({</span><span class="nx">onClick</span><span class="p">,</span> <span class="nx">count</span><span class="p">})</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">onClick</span><span class="p">}&gt;{</span><span class="nx">count</span><span class="p">}&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">})</span>

<span class="kd">function</span> <span class="nx">DualCounter</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">count1</span><span class="p">,</span> <span class="nx">setCount1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">increment1</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useCallback</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">setCount1</span><span class="p">(</span><span class="nx">c</span> <span class="p">=&gt;</span> <span class="nx">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[])</span>

  <span class="kr">const</span> <span class="p">[</span><span class="nx">count2</span><span class="p">,</span> <span class="nx">setCount2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">increment2</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useCallback</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">setCount2</span><span class="p">(</span><span class="nx">c</span> <span class="p">=&gt;</span> <span class="nx">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[])</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;&gt;</span>
      <span class="p">&lt;</span><span class="nt">CountButton</span> <span class="na">count</span><span class="o">=</span><span class="p">{</span><span class="nx">count1</span><span class="p">}</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">increment1</span><span class="p">}</span> <span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nt">CountButton</span> <span class="na">count</span><span class="o">=</span><span class="p">{</span><span class="nx">count2</span><span class="p">}</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">increment2</span><span class="p">}</span> <span class="p">/&gt;</span>
    <span class="o">&lt;</span><span class="err">/&gt;</span>
  <span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>现在我们可以避免 <code>CountButton</code> 的所谓“不必要的重新渲染”。</p>

<p>我想重申下，<strong>在没有测量前</strong>，强烈建议不要使用 <code>React.Memo</code> （或者它的朋友 <code>PureComponent</code> 和 <code>shouldComponentUpdate</code>），因为优化总会带来成本，并且你需要确保知道会有多少成本和收益，这样你才能决定在你的案例中它是否能真的有帮助（而不是有害的）。正如我们上面所说的那样，<strong>一直保持正确是一件很困难的事情，所以你可能无法获得任何好处</strong>。</p>

<h2 id="昂贵的计算">昂贵的计算</h2>

<p>这是 <code>useMemo</code> 内置于 React 的另一个原因（注意这个不适用于 <code>useCallback</code>）。<code>useMemo</code> 的好处是你可以采用如下值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span><span class="nx">b</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">b</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>然后惰性获取：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useMemo</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">({</span><span class="nx">b</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">b</span><span class="p">}),</span> <span class="p">[</span><span class="nx">props</span><span class="p">.</span><span class="nx">b</span><span class="p">])</span>
</code></pre></td></tr></table>
</div>
</div>
<p>这对于上面的情况并不是很有用，但是想象一下你有一个计算成本很高的同步计算值的函数（我的意思是有多少应用真实地需要 <a href="https://developer.mozilla.org/en-US/docs/Tools/Performance/Scenarios/Intensive_JavaScript">像这样计算素数</a>，但这就是一个例子）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kd">function</span> <span class="nx">RenderPrimes</span><span class="p">({</span><span class="nx">iterations</span><span class="p">,</span> <span class="nx">multiplier</span><span class="p">})</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">primes</span> <span class="o">=</span> <span class="nx">calculatePrimes</span><span class="p">(</span><span class="nx">iterations</span><span class="p">,</span> <span class="nx">multiplier</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">Primes</span><span class="o">!</span> <span class="p">{</span><span class="nx">primes</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>使用正确的 <code>iterations</code> 或 <code>multiplier</code> 可能会非常缓慢，而且你没有太多可以特别做的事情。你不能自动地用户的硬件更快，但是你可以这样做，这样你就不必连续两次计算相同的值，这就是 <code>useMemo</code> 为你所做的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-react" data-lang="react"><span class="kd">function</span> <span class="nx">RenderPrimes</span><span class="p">({</span><span class="nx">iterations</span><span class="p">,</span> <span class="nx">multiplier</span><span class="p">})</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">primes</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useMemo</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calculatePrimes</span><span class="p">(</span><span class="nx">iterations</span><span class="p">,</span> <span class="nx">multiplier</span><span class="p">),</span> <span class="p">[</span>
    <span class="nx">iterations</span><span class="p">,</span>
    <span class="nx">multiplier</span><span class="p">,</span>
  <span class="p">])</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">Primes</span><span class="o">!</span> <span class="p">{</span><span class="nx">primes</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以这样做的原因是，即使你在每次渲染时定义了计算素数的函数（非常快），React只在需要值时才调用该函数。 除此之外，React还会在给定输入的情况下存储先前的值，并在给定跟之前相同输入的情况下返回先前的值。 这是 <strong>memoization</strong> 在起作用。</p>

<h2 id="总结">总结</h2>

<p>最后，我想说，每个抽象(和性能优化)都是有代价的。应用 <a href="https://kentcdodds.com/blog/aha-programming">AHA 编程原则</a>，直到确实需要抽象或优化时才去做，这样可以避免承担成本而不会获得收益的情况。</p>

<p>具体来说，<code>useCallback</code> 和 <code>useMemo</code>的成本是：对于你的同事来说，你使代码更复杂了；你可能在依赖项数组中犯了一个错误，并且你可能通过调用内置的 hook、并防止依赖项和 memoized 值被垃圾收集，而使性能变差。如果你获得了必要的性能收益，那么这些成本都是值得承担的，但<strong>最好先测量一下</strong>。</p>

<p>相关阅读：</p>

<ul>
<li>React FAQ: <a href="https://reactjs.org/docs/hooks-faq.html#are-hooks-slow-because-of-creating-functions-in-render">&ldquo;Are Hooks slow because of creating functions in render?&rdquo;</a></li>
<li><a href="https://twitter.com/ryanflorence">Ryan Florence</a>: <a href="https://reacttraining.com/blog/react-inline-functions-and-performance">React, Inline Functions, and Performance</a></li>
</ul>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">君临</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-08-19 21:88</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener external nofollow" href="https://creativecommons.org/licenses/by/4.0/deed.zh" >署名 4.0 国际</a></span>
  </p>
</div>

    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/images/wechat-reward-code.jpg">
        <span>微信打赏</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/images/alipay-qr-code.jpg">
        <span>支付宝打赏</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://jancat.github.io/tags/react/">React</a>
          <a href="https://jancat.github.io/tags/usememo/">useMemo</a>
          <a href="https://jancat.github.io/tags/usecallback/">useCallback</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/2019/node-cluster-workers-ipc/">
            <span class="next-text nav-default">Node Cluster Workers IPC</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "Jancat/Jancat.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    显示 Disqus 评论
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "https://jancat.github.io/post/2019/translation-usememo-and-usecallback/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'jancat';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>

    

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:szujunlinpan@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/4281309/junlin" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://github.com/Jancat" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/Jancat/" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>


<a href="https://jancat.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        君临
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
