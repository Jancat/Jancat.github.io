<!DOCTYPE html>
<html lang="zh" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>使用Node和Typescript爬取花瓣网图片 - 键落云起</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="君临" />
  <meta name="description" content="" />

  <meta name="keywords" content="Hugo, theme, jane, 博客" />






<meta name="generator" content="Hugo 0.55.2" />


<link rel="canonical" href="https://jancat.github.io/post/2018/huaban-crawler-with-node-and-typescript/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.ec807d8b802a40889537c26e014f733206312ea440d42e1f0dabed80918de1ac.css" integrity="sha256-7IB9i4AqQIiVN8JuAU9zMgYxLqRA1C4fDavtgJGN4aw=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="使用Node和Typescript爬取花瓣网图片" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jancat.github.io/post/2018/huaban-crawler-with-node-and-typescript/" />
<meta property="article:published_time" content="2018-04-19T04:03:44&#43;00:00"/>
<meta property="article:modified_time" content="2018-07-08T22:38:54&#43;08:00"/>

<meta itemprop="name" content="使用Node和Typescript爬取花瓣网图片">
<meta itemprop="description" content="">


<meta itemprop="datePublished" content="2018-04-19T04:03:44&#43;00:00" />
<meta itemprop="dateModified" content="2018-07-08T22:38:54&#43;08:00" />
<meta itemprop="wordCount" content="0">



<meta itemprop="keywords" content="花瓣,爬虫,huaban,crawler,Node,TypeScript," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用Node和Typescript爬取花瓣网图片"/>
<meta name="twitter:description" content=""/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138698332-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">键落云起</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/about/">关于</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      键落云起
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://jancat.github.io/about/">关于</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">使用Node和Typescript爬取花瓣网图片</h1>
      
      <div class="post-meta">
        <time datetime="2018-04-19" class="post-time">
          2018-04-19
        </time>
        <div class="post-category">
            <a href="https://jancat.github.io/categories/node/"> Node </a>
            <a href="https://jancat.github.io/categories/typescript/"> TypeScript </a>
            
          </div>
        <span class="more-meta"> 约 0 字 </span>
          <span class="more-meta"> 预计阅读 0 分钟 </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
          <span id="/post/2018/huaban-crawler-with-node-and-typescript/" class="leancloud_visitors" data-flag-title="使用Node和Typescript爬取花瓣网图片">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#前言">前言</a>
<ul>
<li><a href="#技术选型">技术选型</a></li>
</ul></li>
<li><a href="#花瓣网技术分析">花瓣网技术分析</a>
<ul>
<li><a href="#画板资源">画板资源</a></li>
<li><a href="#board-data">Board Data</a></li>
<li><a href="#图片懒加载">图片懒加载</a></li>
</ul></li>
<li><a href="#node-爬虫实现">Node 爬虫实现</a>
<ul>
<li><a href="#输入画板id下载该画板的所有图片">输入画板ID下载该画板的所有图片</a></li>
<li><a href="#输入用户id下载该用户所有自建画板的图片-不包括收藏的画板">输入用户ID下载该用户所有自建画板的图片（不包括收藏的画板）</a></li>
</ul></li>
<li><a href="#总结">总结</a></li>
<li><a href="#github-project">Github Project</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p><img src="/images/post/huaban-crawler-with-node-and-typescript/huban-logo.jpg" alt="huban-logo" /></p>

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

<ul>
<li><a href="#前言">前言</a>

<ul>
<li><a href="#技术选型">技术选型</a></li>
</ul></li>
<li><a href="#花瓣网技术分析">花瓣网技术分析</a>

<ul>
<li><a href="#画板资源">画板资源</a></li>
<li><a href="#board-data">Board Data</a></li>
<li><a href="#图片懒加载">图片懒加载</a></li>
</ul></li>
<li><a href="#node-爬虫实现">Node 爬虫实现</a>

<ul>
<li><a href="#输入画板id下载该画板的所有图片">输入画板ID下载该画板的所有图片</a></li>
<li><a href="#输入用户id下载该用户所有自建画板的图片不包括收藏的画板">输入用户ID下载该用户所有自建画板的图片（不包括收藏的画板）</a></li>
</ul></li>
<li><a href="#总结">总结</a></li>
<li><a href="#github-project">Github Project</a></li>
</ul>

<!-- /code_chunk_output -->

<h2 id="前言">前言</h2>

<p><a href="https://huaban.com">花瓣网</a> 最初是模仿国外的 <a href="https://www.pinterest.com/">Pinterest</a> 开始做起来的图片采集分享网站，国内类似的网站有<a href="https://www.duitang.com/">堆糖</a>。在初期的用户积累阶段过后，花瓣网近几年开始探索其商业模式，以“图”为中心向相关领域延伸（摄影、设计、Live、电商导购等），不过不管怎么发展，用户体验还是要放在首位的，不忘初衷。</p>

<p>作为国内优秀的图片网站,其流畅的瀑布流图片展示、简单易用的图片采集分类方式、强大的图片采集插件，让我这个图控坚持在这里深耕多年，采集了几万张图片，骗粉几千个（欢迎关注 <a href="http://huaban.com/junlin/">http://huaban.com/junlin/</a> ）。</p>

<p>然而对于<strong>图控+收藏控</strong>来说，花瓣网也只是<strong>个人图库大计</strong>中的其中一环，毕竟还是有很多<del>私图</del>不宜光明正大放出来的，花瓣网也有违规图片检测机制，所以需要汇总花瓣网采集的图片到个人存储库中（网盘or硬盘）；此为<u>纯纯的</u>动机，也是本文出现的原因。</p>

<h3 id="技术选型">技术选型</h3>

<p>这么多图片手工一个个下载肯定是不现实的，花瓣网也没有提供批量下载画板的功能（要是有就省心了，可能是考虑到这功能开放后会影响网站运营），这样就催生了很多批量下载工具、脚本（<a href="https://www.douban.com/group/473118/">豆皮DouP相册下载器豆瓣小组</a>、Github 爬虫项目），基本都能很方便的下载。</p>

<p>本着一颗不安分喜欢折腾的心，也是出于技术学习目的，打算自己实现一个批量下载的爬虫脚本。虽然爬虫首选Python，但，作为相信着 <strong>Atwood定律</strong> 的前端er，</p>

<blockquote>
<p>any application that can be written in JavaScript, will eventually be written in JavaScript.
（任何能够用JavaScript实现的应用，最终都必将由JavaScript实现。）
&ndash; Jeff Atwood</p>
</blockquote>

<p>很自然的选择了 <strong>Node.js</strong> ，再加上越来越来流行的 <strong>TypeScript</strong>，如虎添翼，Perfect！</p>

<h2 id="花瓣网技术分析">花瓣网技术分析</h2>

<p>首先打开花瓣网任意一个<strong>画板</strong>，在 Chrome DevTools - Network 下观察它和服务器之前的交互。</p>

<h3 id="画板资源">画板资源</h3>

<p>刷新后发现有很多网络请求，注意到最开始有个带有<strong>画板ID</strong>的 Request <a href="http://huaban.com/boards/17473820/">http://huaban.com/boards/17473820/</a> ，应该就是它了，服务器响应的是一个 HTML Document。</p>

<p><img src="/images/post/huaban-crawler-with-node-and-typescript/board-request.png" alt="board-request" /></p>

<h3 id="board-data">Board Data</h3>

<p>在这个 HTML Document 中发现有个 <code>&lt;script&gt;</code> 中带有大量的 <strong>board</strong> 数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">app</span><span class="p">.</span><span class="nx">page</span><span class="p">[</span><span class="s1">&#39;board&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">board_id</span><span class="o">:</span> <span class="mi">17473820</span><span class="p">,</span>
  <span class="nx">user_id</span><span class="o">:</span> <span class="mi">14191742</span><span class="p">,</span>
  <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;◈ 二次元 少女 ◈&#39;</span><span class="p">,</span>
  <span class="nx">description</span><span class="o">:</span> <span class="s1">&#39;三次元之外的一片净土，满满的治愈~&#39;</span><span class="p">,</span>
  <span class="nx">category_id</span><span class="o">:</span> <span class="s1">&#39;anime&#39;</span><span class="p">,</span>
  <span class="nx">seq</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="nx">pin_count</span><span class="o">:</span> <span class="mi">12627</span><span class="p">,</span>
  <span class="nx">follow_count</span><span class="o">:</span> <span class="mi">1004</span><span class="p">,</span>
  <span class="nx">like_count</span><span class="o">:</span> <span class="mi">37</span><span class="p">,</span>
  <span class="nx">created_at</span><span class="o">:</span> <span class="mi">1410342416</span><span class="p">,</span>
  <span class="nx">updated_at</span><span class="o">:</span> <span class="mi">1523766920</span><span class="p">,</span>
  <span class="nx">deleting</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">is_private</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">extra</span><span class="o">:</span> <span class="p">{</span> <span class="nx">cover</span><span class="o">:</span> <span class="p">{</span> <span class="nx">pin_id</span><span class="o">:</span> <span class="s1">&#39;407033830&#39;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="nx">user</span><span class="o">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">},</span>
  <span class="nx">category_name</span><span class="o">:</span> <span class="s1">&#39;动漫&#39;</span><span class="p">,</span>
  <span class="nx">following</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">liked</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">pins</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">pin_id</span><span class="o">:</span> <span class="mi">1595477246</span><span class="p">,</span>
      <span class="nx">user_id</span><span class="o">:</span> <span class="mi">14191742</span><span class="p">,</span>
      <span class="nx">board_id</span><span class="o">:</span> <span class="mi">17473820</span><span class="p">,</span>
      <span class="nx">file_id</span><span class="o">:</span> <span class="mi">183940093</span><span class="p">,</span>
      <span class="nx">file</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">id</span><span class="o">:</span> <span class="mi">183940093</span><span class="p">,</span>
        <span class="nx">farm</span><span class="o">:</span> <span class="s1">&#39;farm1&#39;</span><span class="p">,</span>
        <span class="nx">bucket</span><span class="o">:</span> <span class="s1">&#39;hbimg&#39;</span><span class="p">,</span>
        <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;95b6f7594128756a5fb415188cb5761c4139cebbf359b-R9Dvyn&#39;</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span>
        <span class="nx">width</span><span class="o">:</span> <span class="mi">752</span><span class="p">,</span>
        <span class="nx">height</span><span class="o">:</span> <span class="mi">1062</span><span class="p">,</span>
        <span class="nx">frames</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">colors</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">color</span><span class="o">:</span> <span class="mi">5934</span><span class="p">,</span> <span class="nx">ratio</span><span class="o">:</span> <span class="mf">0.09</span> <span class="p">}],</span>
        <span class="nx">theme</span><span class="o">:</span> <span class="s1">&#39;00172e&#39;</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">media_type</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;pixiv.net&#39;</span><span class="p">,</span>
      <span class="nx">link</span><span class="o">:</span> <span class="s1">&#39;https://www.pixiv.net/member_illust.php?mode=medium&amp;illust_id=67752097&#39;</span><span class="p">,</span>
      <span class="nx">raw_text</span><span class="o">:</span> <span class="s1">&#39;奏さん&#39;</span><span class="p">,</span>
      <span class="nx">text_meta</span><span class="o">:</span> <span class="p">{</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[]</span> <span class="p">},</span>
      <span class="nx">via</span><span class="o">:</span> <span class="mi">1587727234</span><span class="p">,</span>
      <span class="nx">via_user_id</span><span class="o">:</span> <span class="mi">8451317</span><span class="p">,</span>
      <span class="nx">original</span><span class="o">:</span> <span class="mi">1568136527</span><span class="p">,</span>
      <span class="nx">created_at</span><span class="o">:</span> <span class="mi">1523444564</span><span class="p">,</span>
      <span class="nx">like_count</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">comment_count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">repin_count</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="nx">is_private</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">extra</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">orig_source</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">tags</span><span class="o">:</span> <span class="p">[],</span>
    <span class="p">},</span>
    <span class="p">{</span> <span class="p">...</span> <span class="p">},</span>
    <span class="p">...</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>其中 <code>app.page.board.pins</code> 是一个对象数组，里面每个对象对应着画板中其中一张图片的信息，<code>pin</code> 代表一张图片的信息。</p>

<p>在网页中检查第一张图片的源 <code>&lt;img src=&quot;//img.hb.aicdn.com/95b6f7594128756a5fb415188cb5761c4139cebbf359b-R9Dvyn_fw236&quot;&gt;</code>，可以发现花瓣网图片使用了又拍云的CDN服务，第二部分即是上面的 <code>pins[0].file.key</code> 加上一个 <code>_fw236</code> 后缀；其它图片的 <code>src</code> 都带有这个 <code>_fw236</code> 后缀，暂时还不知道它的意义。</p>

<p>拿到了画板图片信息，到这一步就能想到可以通过爬虫来下载画板的图片。</p>

<h3 id="图片懒加载">图片懒加载</h3>

<p>再回到画板网页上，看到页面上目前只加载了画板一部分图片，剩下的图片是通过<strong>懒加载</strong>的方式出现的（想想就知道不能一次性把所有图片都加载出来）。</p>

<p>拖动滚动条到底部，继续观察 <strong>Network</strong>，第一个请求 <a href="http://huaban.com/boards/17473820/?jg6ltavl&amp;max=1584529804&amp;limit=20&amp;wfl=1">http://huaban.com/boards/17473820/?jg6ltavl&amp;max=1584529804&amp;limit=20&amp;wfl=1</a> 在画板ID后面携带了一些参数：</p>

<p><img src="/images/post/huaban-crawler-with-node-and-typescript/board-lazy-load.png" alt="board-lazy-load" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">jg6ltavl</span><span class="o">:</span> 
<span class="nx">max</span><span class="o">:</span> <span class="mi">1584529804</span>
<span class="nx">limit</span><span class="o">:</span> <span class="mi">20</span>
<span class="nx">wfl</span><span class="o">:</span> <span class="mi">1</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>第一个参数是个随机字符串，最后一位按字母表顺序循环，没发现有什么意义，忽略；</li>
<li>第二个参数 <strong>max</strong> 的值是个 <strong>pin_id</strong> ；</li>
<li>第三个参数 <strong>limit</strong> 限制了服务器返回的 <strong>pin 数量</strong>；</li>
<li>第四个参数 <strong>wfl</strong> 可能是 <strong>waterfall</strong> 瀑布流的缩写，没发现有什么意义，忽略。</li>
</ul>

<p>重点是 <strong>max</strong> 和 <strong>limit</strong> 这两个值，经过测试发现，<strong>max</strong> 是上一张图片的 <strong>pin_id</strong>，服务器按先后顺序（采集顺序）返回这张图片<strong>后面</strong>的 pin 数据；</p>

<p>而 <strong>limit</strong> 告诉服务器返回<strong>多少个</strong> pin 数据。后面测出服务器对 <strong>limit</strong> 做了最大值校验，最大是 <strong>100</strong>，即一次最多只能加载100张图片数据。</p>

<p>到了现在可以开始写爬虫模拟上面的操作了。</p>

<h2 id="node-爬虫实现">Node 爬虫实现</h2>

<p>使用 Node.js 实现命令行程序，提供两种方式下载图片：</p>

<ol>
<li>输入<strong>画板ID</strong>下载该画板的所有图片</li>
<li>输入<strong>用户ID</strong>下载该用户所有自建画板的图片（不包括收藏的画板）</li>
</ol>

<h3 id="输入画板id下载该画板的所有图片">输入画板ID下载该画板的所有图片</h3>

<ol>
<li><p>在命令行中跟用户交互，使用 Node <code>readline</code> API实现在 <code>stdin/stdout</code> 读取输入和显示输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">import</span> <span class="nx">readline</span> <span class="nx">from</span> <span class="s1">&#39;readline&#39;</span>

<span class="kr">const</span> <span class="nx">rl</span>: <span class="kt">readline.ReadLine</span> <span class="o">=</span> <span class="nx">readline</span><span class="p">.</span><span class="nx">createInterface</span><span class="p">({</span>
  <span class="nx">input</span>: <span class="kt">process.stdin</span><span class="p">,</span>
  <span class="nx">output</span>: <span class="kt">process.stdout</span><span class="p">,</span>
<span class="p">})</span>
<span class="nx">rl</span><span class="p">.</span><span class="nx">question</span><span class="p">(</span><span class="s1">&#39;画板ID：&#39;</span><span class="p">,</span> <span class="nx">boardId</span> <span class="o">=&gt;</span> <span class="p">{})</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>首先根据画板ID获取 <code>board</code> 数据，然后获取到 <code>board</code> 中所有的 <code>pins</code> 数据，最后根据每个 <code>pin</code> 数据下载图片到本地目录中，中间向命令行中输出一些提示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="nx">async</span> <span class="kd">function</span> <span class="nx">downloadSingleBoard</span><span class="p">(</span><span class="nx">boardId</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="s1">&#39;Total time&#39;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">board</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getBoardInfo</span><span class="p">(</span><span class="nx">boardId</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n开始下载画板 %s - %s，图片数量：%d&#39;</span><span class="p">,</span> <span class="nx">boardId</span><span class="p">,</span> <span class="nx">board</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">board</span><span class="p">.</span><span class="nx">pin_count</span><span class="p">)</span>

  <span class="nx">await</span> <span class="nx">getPinsAndDownload</span><span class="p">(</span><span class="nx">board</span><span class="p">)</span>
  <span class="nx">outputResult</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>根据画板ID获取 <code>board</code> 数据。为了使用 ES7 的 <code>async/await</code>，引入了 <code>promisify</code> 的 request 库</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="nx">rp</span> <span class="nx">from</span> <span class="s1">&#39;request-promise&#39;</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">getBoardInfo</span><span class="p">(</span><span class="nx">boardId</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">IBoard</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">response</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">err?</span>: <span class="kt">number</span>
    <span class="nx">board</span>: <span class="kt">IBoard</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">rp</span><span class="p">({</span>
    <span class="nx">uri</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">huabanDomain</span><span class="si">}</span><span class="sb">/boards/</span><span class="si">${</span><span class="nx">boardId</span><span class="si">}</span><span class="sb">/`</span><span class="p">,</span>
    <span class="nx">headers</span>: <span class="kt">jsonRequestHeader</span><span class="p">,</span>
    <span class="nx">qs</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">limit</span>: <span class="kt">1</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">json</span>: <span class="kt">true</span><span class="p">,</span>
  <span class="p">})</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">err</span> <span class="o">===</span> <span class="mi">404</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;画板不存在！&#39;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">board</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>获取 <code>pins</code> 数据然后下载图片，输出结果。其中在获取 <code>pins</code> 数据的时候发现有些画板无法获取全部的 <code>pins</code> 数据，造成画板图片下载不全（暂时还不清楚原因）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="nx">async</span> <span class="kd">function</span> <span class="nx">getPinsAndDownload</span><span class="p">(</span><span class="nx">board</span>: <span class="kt">IBoard</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">boardPins</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getPins</span><span class="p">(</span><span class="nx">board</span><span class="p">.</span><span class="nx">board_id</span><span class="p">)</span>
  <span class="c1">// TODO: 有些画板获取的pins数据不全？
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">missedPinsCount</span> <span class="o">=</span> <span class="nx">board</span><span class="p">.</span><span class="nx">pin_count</span> <span class="o">-</span> <span class="nx">boardPins</span><span class="p">.</span><span class="nx">length</span>

  <span class="kr">const</span> <span class="nx">boardPath</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">downloadPath</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">board</span><span class="p">.</span><span class="nx">board_id</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="nx">board</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span><span class="sb">`</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">emptyDirSync</span><span class="p">(</span><span class="nx">boardPath</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">downloadCount</span>: <span class="kt">number</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">downloadImage</span><span class="p">(</span><span class="nx">boardPins</span><span class="p">,</span> <span class="nx">boardPath</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">failedCount</span>: <span class="kt">number</span> <span class="o">=</span> <span class="nx">board</span><span class="p">.</span><span class="nx">pin_count</span> <span class="o">-</span> <span class="nx">downloadCount</span> <span class="o">-</span> <span class="nx">missedPinsCount</span>
  <span class="nx">totalDownload</span> <span class="o">+=</span> <span class="nx">downloadCount</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
    <span class="sb">`Done. 成功 %d 个</span><span class="si">${</span><span class="nx">failedCount</span> <span class="o">?</span> <span class="sb">`，失败 </span><span class="err">\</span><span class="sb">x1b[31m</span><span class="si">${</span><span class="nx">failedCount</span><span class="si">}</span><span class="err">\</span><span class="sb">x1b[0m个`</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="si">}${</span>
      <span class="nx">missedPinsCount</span> <span class="o">?</span> <span class="sb">`，丢失 </span><span class="err">\</span><span class="sb">x1b[31m</span><span class="si">${</span><span class="nx">missedPinsCount</span><span class="si">}</span><span class="err">\</span><span class="sb">x1b[0m 个`</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span>
    <span class="si">}</span><span class="sb">`</span><span class="p">,</span>
    <span class="nx">downloadCount</span><span class="p">,</span>
  <span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>获取画板中全部pins(图片)数据。有个关键的点，请求头部中如果不加上 <code>'X-Requested-With': 'XMLHttpRequest'</code>，服务器返回的是包含json的HMLT Document，而不是单纯的 <code>json</code> 数据。我看到有些脚本没有注意到这点，就需要用正则截取HTML中的 <code>json</code>，多走了一步弯路（我也是从弯路走过来的，这里提醒后面的读者）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="c1">// 关键头部，添加该项后服务器只会返回json数据，而不是包含json的HTML
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">jsonRequestHeader</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">Accept</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
  <span class="s1">&#39;X-Requested-With&#39;</span><span class="o">:</span> <span class="s1">&#39;XMLHttpRequest&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">getPins</span><span class="p">(</span><span class="nx">boardId</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">IPin</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">allPins</span>: <span class="kt">IPin</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="nx">async</span> <span class="kd">function</span> <span class="nx">loadPins</span><span class="p">(</span><span class="nx">lastPinId</span>: <span class="kt">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// limit 查询参数限制获取的pin数量，最大100，默认20
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">rp</span><span class="p">({</span>
      <span class="nx">uri</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">huabanDomain</span><span class="si">}</span><span class="sb">/boards/</span><span class="si">${</span><span class="nx">boardId</span><span class="si">}</span><span class="sb">/`</span><span class="p">,</span>
      <span class="nx">qs</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">limit</span>: <span class="kt">100</span><span class="p">,</span>
        <span class="nx">max</span>: <span class="kt">lastPinId</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">headers</span>: <span class="kt">jsonRequestHeader</span><span class="p">,</span>
      <span class="nx">json</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="kr">const</span> <span class="nx">board</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">board</span>
    <span class="c1">// if (response.headers[&#39;content-type&#39;]!.includes(&#39;text/html&#39;)) {
</span><span class="c1"></span>    <span class="c1">//   // 匹配 boards json 串
</span><span class="c1"></span>    <span class="c1">//   const boardJson: string = /app\.page\[&#34;board&#34;\]\s=\s({.*});/.exec(response)![1]
</span><span class="c1"></span>    <span class="c1">//   board = JSON.parse(boardJson)
</span><span class="c1"></span>    <span class="c1">// }
</span><span class="c1"></span>    <span class="nx">allPins</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">board</span><span class="p">.</span><span class="nx">pins</span><span class="p">)</span>

    <span class="c1">// 当此次获取的pins为空或者全部pins已获取完，则返回
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">pinsChunkLength</span>: <span class="kt">number</span> <span class="o">=</span> <span class="nx">board</span><span class="p">.</span><span class="nx">pins</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pinsChunkLength</span> <span class="o">&amp;&amp;</span> <span class="nx">allPins</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">board</span><span class="p">.</span><span class="nx">pin_count</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 用最后一个pin id作为下一次请求的max值，表示获取该pin后面的pins
</span><span class="c1"></span>      <span class="nx">await</span> <span class="nx">loadPins</span><span class="p">(</span><span class="nx">board</span><span class="p">.</span><span class="nx">pins</span><span class="p">[</span><span class="nx">pinsChunkLength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">pin_id</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">await</span> <span class="nx">loadPins</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">allPins</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>根据 <code>pins</code> 下载图片。这里引入了 <code>async</code> 异步库来控制同一时间的下载并发数，否则并发过高<strong>Node会失去响应</strong>；下载失败的图片还会重试一次</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="nx">async</span> <span class="kd">function</span> <span class="nx">downloadImage</span><span class="p">(</span><span class="nx">allPins</span>: <span class="kt">IPin</span><span class="p">[],</span> <span class="nx">boardPath</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="kt">number</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">downloadCount</span>: <span class="kt">number</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kr">const</span> <span class="nx">errorImageUrl</span>: <span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span> <span class="nx">url</span>: <span class="kt">string</span><span class="p">;</span> <span class="nx">path</span>: <span class="kt">string</span> <span class="p">}</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1">// 重试下载失败的图片
</span><span class="c1"></span>  <span class="kd">function</span> <span class="nx">retry() {</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">image</span> <span class="nx">of</span> <span class="nx">errorImageUrl</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rp</span><span class="p">({</span>
        <span class="nx">uri</span>: <span class="kt">image.url</span><span class="p">,</span>
        <span class="nx">timeout</span>: <span class="kt">20</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="nx">encoding</span>: <span class="kt">null</span><span class="p">,</span> <span class="c1">// make response a Buffer to write image correctly
</span><span class="c1"></span>      <span class="p">}).</span><span class="nx">pipe</span><span class="p">(</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">path</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;finish&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">totalDownload</span><span class="o">++</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\x1b[32m Retry ok! \x1b[0m %s&#39;</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
        <span class="p">}),</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">download</span><span class="p">(</span><span class="nx">pin</span>: <span class="kt">IPin</span><span class="p">,</span> <span class="nx">cb</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">imageUrl</span>: <span class="kt">string</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">imageServer</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">pin</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">key</span><span class="si">}</span><span class="sb">_fw658`</span>
    <span class="kr">const</span> <span class="nx">imageName</span>: <span class="kt">string</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">pin</span><span class="p">.</span><span class="nx">pin_id</span><span class="si">}${</span><span class="nx">imagesTypes</span><span class="p">[</span><span class="nx">pin</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;.jpg&#39;</span><span class="si">}</span><span class="sb">`</span>

    <span class="nx">rp</span><span class="p">({</span>
      <span class="nx">uri</span>: <span class="kt">imageUrl</span><span class="p">,</span>
      <span class="nx">timeout</span>: <span class="kt">20</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
      <span class="nx">encoding</span>: <span class="kt">null</span><span class="p">,</span> <span class="c1">// make response a Buffer to write image correctly
</span><span class="c1"></span>    <span class="p">})</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">downloadCount</span><span class="o">++</span>

        <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">boardPath</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">imageName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;\x1b[31m%s\x1b[0m%s&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">imageUrl</span><span class="p">)</span>
        <span class="p">})</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;\x1b[31m%s %s.\x1b[0m %s&#39;</span><span class="p">,</span> <span class="s1">&#39;Download image failed.&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">imageUrl</span><span class="p">)</span>
        <span class="nx">errorImageUrl</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">url</span>: <span class="kt">imageUrl</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">boardPath</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">imageName</span><span class="si">}</span><span class="sb">`</span> <span class="p">})</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">finally</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// async控制并发下载数，否则并发数太高Node会失去响应
</span><span class="c1"></span>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="kt">number</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// 同一时间最多有10个(不能太高)并发请求
</span><span class="c1"></span>    <span class="nx">async</span><span class="p">.</span><span class="nx">eachLimit</span><span class="p">(</span><span class="nx">allPins</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">download</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span>: <span class="kt">IError</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">error</span>
      <span class="p">}</span>
      <span class="nx">errorImageUrl</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">retry</span><span class="p">()</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">downloadCount</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>下载的图片会保存在默认 <code>images</code> 目录或者用户输入的指定目录中，下载速度平均 5 张/秒</p></li>
</ol>

<h3 id="输入用户id下载该用户所有自建画板的图片-不包括收藏的画板">输入用户ID下载该用户所有自建画板的图片（不包括收藏的画板）</h3>

<ol>
<li><p>命令行中输入用户ID</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="nx">rl</span><span class="p">.</span><span class="nx">question</span><span class="p">(</span><span class="s1">&#39;请输入地址栏中的用户名：&#39;</span><span class="p">,</span> <span class="nx">username</span> <span class="o">=&gt;</span> <span class="p">{})</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>首先获取到该用户的所有画板数据，然后顺序下载每个画板中的图片</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="nx">async</span> <span class="kd">function</span> <span class="nx">downloadBoardsOfUser</span><span class="p">(</span><span class="nx">username</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="s1">&#39;Total time&#39;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">userBoards</span>: <span class="kt">IBoard</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getUserBoards</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n用户 [%s] 画板数量：%d&#39;</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">userBoards</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>

  <span class="c1">// 顺序下载画板，并行下载会失控
</span><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">board</span> <span class="nx">of</span> <span class="nx">userBoards</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
      <span class="s1">&#39;\n开始下载画板：[%s - %s]，图片数量：%d&#39;</span><span class="p">,</span>
      <span class="nx">board</span><span class="p">.</span><span class="nx">board_id</span><span class="p">,</span>
      <span class="nx">board</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
      <span class="nx">board</span><span class="p">.</span><span class="nx">pin_count</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nx">await</span> <span class="nx">getPinsAndDownload</span><span class="p">(</span><span class="nx">board</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">outputResult</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>获取用户画板。用户画板也使用了懒加载方式，所以也需要去循环获取</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="nx">async</span> <span class="kd">function</span> <span class="nx">getUserBoards</span><span class="p">(</span><span class="nx">username</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">IBoard</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">allUserBoards</span>: <span class="kt">IBoard</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="nx">async</span> <span class="kd">function</span> <span class="nx">getBoards</span><span class="p">(</span><span class="nx">lastBoardId?</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">response</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">err?</span>: <span class="kt">number</span>
      <span class="nx">user?</span>: <span class="kt">IUser</span>
    <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">rp</span><span class="p">({</span>
      <span class="nx">uri</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">huabanDomain</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">username</span><span class="si">}</span><span class="sb">/`</span><span class="p">,</span>
      <span class="nx">qs</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">limit</span>: <span class="kt">100</span><span class="p">,</span>
        <span class="nx">max</span>: <span class="kt">lastBoardId</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">headers</span>: <span class="kt">jsonRequestHeader</span><span class="p">,</span>
      <span class="nx">json</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">err</span> <span class="o">===</span> <span class="mi">404</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;用户不存在！&#39;</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">user</span><span class="o">!</span><span class="p">.</span><span class="nx">board_count</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;用户没有画板！&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">user</span>: <span class="kt">IUser</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">user</span><span class="o">!</span>
    <span class="kr">const</span> <span class="nx">requestUserBoardsCount</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">boards</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">allUserBoards</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">user</span><span class="p">.</span><span class="nx">boards</span><span class="p">)</span>

    <span class="c1">// 获取所有画板数据
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">requestUserBoardsCount</span> <span class="o">&amp;&amp;</span> <span class="nx">allUserBoards</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">board_count</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">await</span> <span class="nx">getBoards</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">boards</span><span class="p">[</span><span class="nx">requestUserBoardsCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">board_id</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">await</span> <span class="nx">getBoards</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">allUserBoards</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>后面步骤跟方式一相同，这里只是使用 <code>for</code> 循环下载多个画板图片</p></li>
</ol>

<h2 id="总结">总结</h2>

<p>这次爬虫几乎没有遇到服务器的反抗，花瓣网没有做反爬虫检测，最基本的 <code>User-Agent</code> 都不需要伪装，很适合爬虫初学者拿来练手；这种开放共享的精神值得表扬👍。</p>

<p>遗留下了有些画板 <code>pins</code> 数据不全的问题，等待有缘再解决。</p>

<h2 id="github-project">Github Project</h2>

<p>项目引入了 <code>TSLint</code>、<code>Prettier</code> 来规范代码风格，用 <code>ts-node</code> 来执行 <code>.ts</code> 程序；</p>

<p>代码放到Github上了 ➡ <a href="https://github.com/Jancat/huaban-crawl">Jancat/huaban-crawl</a></p>

<p>Enjoy the pictures ~</p>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">君临</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2018-07-08 22:77</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener external nofollow" href="https://creativecommons.org/licenses/by/4.0/deed.zh" >署名 4.0 国际</a></span>
  </p>
</div>

    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/images/wechat-reward-code.jpg">
        <span>微信打赏</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/images/alipay-qr-code.jpg">
        <span>支付宝打赏</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://jancat.github.io/tags/%E8%8A%B1%E7%93%A3/">花瓣</a>
          <a href="https://jancat.github.io/tags/%E7%88%AC%E8%99%AB/">爬虫</a>
          <a href="https://jancat.github.io/tags/huaban/">huaban</a>
          <a href="https://jancat.github.io/tags/crawler/">crawler</a>
          <a href="https://jancat.github.io/tags/node/">Node</a>
          <a href="https://jancat.github.io/tags/typescript/">TypeScript</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/2018/how-to-select-the-way-to-post-teach-blog/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">如何选择技术博客的发布方式</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
      </nav>
    </footer>
  </article>

  
  

  
  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "Jancat/Jancat.github.io"
            issue-term="pathname"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    显示 Disqus 评论
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "https://jancat.github.io/post/2018/huaban-crawler-with-node-and-typescript/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = '君临';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:szujunlinpan@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/4281309/junlin" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://github.com/Jancat" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/Jancat/" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>


<a href="https://jancat.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        君临
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize("WY7BT0yGeBqzYyvhQdTtDHhe-gzGzoHsz", "UiuNLWUp5qsmPjd5gx4J2Oqr");
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>







</body>
</html>
